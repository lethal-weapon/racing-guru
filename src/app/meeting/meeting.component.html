<app-toast-websocket></app-toast-websocket>

<div *ngIf="isLoading">
  <app-spinner></app-spinner>
</div>

<div *ngIf="!isLoading">
  <div class="mt-4 flex flex-row justify-evenly">
    <div *ngIf="summaryLines.length > 0"
         class="px-6 py-4 text-xl rounded-2xl shadow-md transition shadow-sky-700/50 hover:shadow-sky-600"
    >
      {{ summaryLines[0] }}
      <br>
      {{ summaryLines[1] }}
    </div>
    <div class="p-2 text-xl rounded-2xl shadow-md transition shadow-sky-700/50 hover:shadow-sky-600">
      <table>
        <tr *counter="let row of (pools.length / 4)">
          <td *ngFor="let obj of pools.slice((row-1) * 4, (row-1) * 4 + 4)"
              class="p-1"
          >
            <div class="flex flex-row justify-between hover:text-yellow-400">
              <div class="px-2 font-bold">{{ obj.pool }}&#58;</div>
              <div class="px-2">${{ obj.amount }}M</div>
            </div>
          </td>
        </tr>
      </table>
    </div>
    <div class="w-40 pt-2 text-center">
      <div class="text-2xl">
        NEXT RACE
      </div>
      <div class="pt-2 text-4xl text-red-600">
        {{ remainingTime }}
      </div>
    </div>
  </div>

  <table class="mt-4 mx-auto table-fixed border-collapse border border-gray-500 text-center">
    <thead>
      <th class="w-20 border border-gray-600"
          [class.border-b-red-900]="nextRace === 1"
      >
        <i class="fa fa-dollar fa-lg"></i>
      </th>
      <th *ngFor="let jockey of jockeys"
          class="w-20 border border-gray-600"
          [class.border-r-red-900]="isBoundaryPlayer(jockey, true)"
          [class.border-b-red-900]="nextRace === 1"
      >
        <div [class.text-yellow-400]="getMeetingEarning(jockey) >= EARNING_THRESHOLD">
          {{ getMeetingEarning(jockey) === 0 ? '-' : getMeetingEarning(jockey) }}
        </div>
        <div>
          {{ jockey }}
        </div>
      </th>
    </thead>
    <tbody>
      <tr *ngFor="let race of racecards">
        <td class="border border-gray-700"
            [class.text-yellow-400]="isSpecialRace(race)"
            [class.border-b-red-900]="race.race === lastRace"
            tooltip="{{getRaceTooltip(race)}}"
            [hideDelay]="0"
        >
          <div class="hover:underline">
            <a [href]="race.resultUrl" target="_blank">
              {{ race.race == 10 ? 'X' : (race.race == 11 ? 'E' : race.race) }}
              {{ formatRaceGrade(race.grade) }}
            </a>
          </div>
          <div class="hover:underline">
            <a [href]="race.replayUrl" target="_blank">
              {{ race.distance }}
            </a>
          </div>
        </td>
        <td *ngFor="let jockey of jockeys"
            class="border border-gray-700 hover:bg-gray-800 text-sm {{toPlacingColor(getStarter(jockey, race)?.placing)}}"
            [class.border-r-red-900]="isBoundaryPlayer(jockey, true)"
            [class.border-b-red-900]="race.race === lastRace"
            [class.border-b-gray-900]="hideBottomBorder(jockey, race)"
            [class.border-r-gray-900]="hideRightBorder(jockey, race)"
            [class.bg-gray-700]="activeTrainer === getTrainer(jockey, race) && activeTrainerAnimationOn"
        >
          <div *ngIf="rideThisRace(jockey, race)"
               class="flex flex-col"
               tooltip="{{getStarterTooltip(jockey, race)}}"
               [hideDelay]="0"
          >
            <div class="flex flex-row justify-between">
              <div class="w-5 h-5 rounded-full border cursor-pointer"
                   [class.border-gray-700]="!isPersonalFavorite(getStarter(jockey, race), race.race)"
                   [class.border-yellow-400]="isPersonalFavorite(getStarter(jockey, race), race.race)"
                   [class.text-yellow-400]="isPersonalFavorite(getStarter(jockey, race), race.race)"
                   (click)="toggleFavorite(getStarter(jockey, race), race)"
              >
                {{ getStarter(jockey, race).order }}
              </div>
              <div>
                <a [href]="toHorseProfileUrl(getStarter(jockey, race).horse)"
                   target="_blank"
                >
                  {{ getStarter(jockey, race).horse[0] }}
                </a>
              </div>
              <div class="w-5 h-5 border cursor-pointer"
                   [class.border-gray-700]="activeDraw !== getStarter(jockey, race).draw"
                   [class.border-yellow-400]="activeDraw === getStarter(jockey, race).draw"
                   [class.text-yellow-400]="activeDraw === getStarter(jockey, race).draw"
                   (click)="setActiveDraw(getStarter(jockey, race).draw)"
              >
                {{ getStarter(jockey, race).draw }}
              </div>
            </div>
            <div class="flex flex-row justify-evenly">
              <div *ngIf="isTrainerFinalRace(jockey, race)"
                   class="text-yellow-400"
              >
                &#952;
              </div>
              <div class="cursor-pointer"
                   [class.italic]="isTrainerHasNoStarterNextRace(jockey, race)"
                   [class.underline]="isTrainerHasNoStarterNextRace(jockey, race)"
                   [class.font-bold]="activeTrainer === getTrainer(jockey, race)"
                   [class.text-yellow-400]="activeTrainer === getTrainer(jockey, race)"
                   (click)="toggleActiveTrainer(getTrainer(jockey, race))"
              >
                {{ getTrainer(jockey, race) }}
              </div>
              <div *ngIf="isPublicFavorite(jockey, race)"
                   class="text-yellow-400"
              >
                &#937;
              </div>
            </div>
            <div class="flex flex-row justify-around"
                 [class.font-bold]="race.race == nextRace"
            >
              <div [class.text-red-600]="(race.race == nextRace) || (isUpcomingRacePublicFavorite(jockey, race))">
                {{ getWinPlaceOdds(jockey, race).win == 0 ? '-' : getWinPlaceOdds(jockey, race).win | number: '1.0-1' }}
              </div>
              <div [class.text-blue-600]="race.race == nextRace">
                {{ getWinPlaceOdds(jockey, race).place == 0 ? '-' : getWinPlaceOdds(jockey, race).place | number: '1.0-1' }}
              </div>
            </div>
          </div>
        </td>
      </tr>
    </tbody>
  </table>

  <table *ngIf="maxChallengerOrder > 0"
         class="mt-2 mx-auto table-fixed border-collapse border border-gray-700 text-center"
  >
    <thead>
      <th class="w-28 border border-gray-600 border-b-red-900">
      </th>
      <th *counter="let order of maxChallengerOrder"
          class="w-28 border border-gray-600 border-b-red-900"
      >
        {{ order }}
      </th>
      <th class="w-28 border border-gray-600 border-b-red-900">
        X
      </th>
    </thead>
    <tbody>
      <tr *ngFor="let personType of ['Jockey', 'Jockey', 'Jockey', 'Trainer', 'Trainer', 'Trainer']; let index = index"
          class="hover:bg-gray-800"
      >
        <td class="border border-gray-700"
            [class.border-b-red-900]="index == 2"
        >
          <div *ngIf="index % 3 === 0">
            {{ personType === 'Jockey' ? 'JKC' : 'TNC' }}
          </div>
        </td>
        <td *counter="let order of maxChallengerOrder"
            class="border border-gray-700"
            [class.border-b-red-900]="index == 2"
        >
          <div *ngIf="index % 3 === 0"
               [class.text-yellow-400]="isTopChallengePoint(personType, order)"
          >
            {{ getChallengeOdds(personType, order).challenger }}
            <span *ngIf="getChallengeOdds(personType, order).challenger.length > 0">
              <span *ngIf="getChallengeOdds(personType, order).points > 0">
                ({{ getChallengeOdds(personType, order).points }})
              </span>
            </span>
          </div>
          <div *ngIf="index % 3 === 1">
            {{ formatChallengeOdds(getChallengeOdds(personType, order).odds) }}
          </div>
          <div *ngIf="index % 3 === 2">
            <span *ngIf="getChallengerInvestment(getChallengeOdds(personType, order).challenger) > 0">
              {{ getChallengerInvestment(getChallengeOdds(personType, order).challenger) | percent }}
            </span>
          </div>
        </td>
        <td class="border border-gray-700"
            [class.border-b-red-900]="index == 2"
        >
          <div *ngIf="index % 3 === 0">
            Others
          </div>
          <div *ngIf="index % 3 === 1">
            {{ formatChallengeOdds(getOutsiderChallengeOdds(personType).odds) }}
          </div>
          <div *ngIf="index % 3 === 2">
            {{ getOutsiderChallengerInvestment(personType) | percent }}
          </div>
        </td>
      </tr>
    </tbody>
  </table>

  <table class="mt-2 mx-auto table-fixed border-collapse border border-gray-500 text-center">
    <thead>
      <th *ngFor="let trainer of trainers"
          class="w-20 border border-gray-600 border-b-red-900"
          [class.border-r-red-900]="isBoundaryPlayer(trainer, false)"
      >
        <div [class.text-yellow-400]="getMeetingEarning(trainer) >= EARNING_THRESHOLD">
          {{ getMeetingEarning(trainer) === 0 ? '-' : getMeetingEarning(trainer) }}
        </div>
        <div>
          {{ trainer }}
        </div>
      </th>
    </thead>
    <tbody>
      <tr>
        <td *ngFor="let _ of RATING_GRADES; let index = index; let last = last"
            class="border border-gray-700"
            [class.border-r-red-900]="!last"
            [colSpan]="getTrainerGroup(index).length"
        >
          <div class="flex flex-row flex-wrap justify-center p-2 gap-x-2 gap-y-1">
            <ng-container *counter="let race of maxRace">
              <div *ngFor="let starter of getStartersByTrainerGroup(race, index)"
                   class="{{toPlacingColor(starter.placing)}} text-sm px-1.5 py-0.5
                          rounded-full border border-gray-600 cursor-pointer hover:border-yellow-400"
                   [class.line-through]="starter.scratched"
                   [class.text-yellow-400]="starter.scratched"
                   [class.border-yellow-400]="activeTrainer === starter.trainer && activeTrainerAnimationOn"
                   (click)="toggleActiveTrainer(starter.trainer)"
              >
                <span>
                  {{ race }}/{{ starter.order }}
                </span>
                <span class="text-xs">
                  {{ getHorseDetail(starter.horse, race).name }}
                  <span [class.text-yellow-400]="activeTrainer === starter.trainer">
                    {{ starter.trainer }}
                  </span>
                </span>
                <span *ngIf="getHorseDetail(starter.horse, race).odds > 0"
                      class="{{ toPlacingColor(starter.placing).length === 0
                               ? getOddsIntensityColor(getHorseDetail(starter.horse, race).odds)
                               : ''
                             }}"
                >
                  {{ getHorseDetail(starter.horse, race).odds | number: '1.0-1' }}
                </span>
              </div>
            </ng-container>
          </div>
        </td>
      </tr>
    </tbody>
  </table>

  <table class="mt-2 mx-auto table-fixed border-collapse border border-gray-700 text-center">
    <thead>
      <th class="w-16 border border-gray-600">
        Race
      </th>
      <th class="w-36 border border-gray-600 border-r-red-900">
        Top 4
      </th>
      <th *ngFor="let pool of singleRacePools"
          class="w-20 border border-gray-600"
          [class.border-r-red-900]="BOUNDARY_POOLS.includes(pool.name)"
      >
        {{ pool.name }}
      </th>
    </thead>
    <tbody>
      <tr *counter="let race of maxRace"
          class="hover:bg-gray-800"
      >
        <td class="border border-gray-700"
            [class.border-b-red-900]="race === maxRace"
        >
          {{ formatRace(race) }}
        </td>
        <td class="px-1 border border-gray-700 border-r-red-900"
            [class.border-b-red-900]="race === maxRace"
        >
          <div class="grid grid-cols-4">
            <div *ngFor="let order of getDividendTop4(race)">
              {{ order }}
            </div>
          </div>
        </td>
        <td *ngFor="let pool of singleRacePools"
            class="border border-gray-700"
            [class.border-b-red-900]="race === maxRace"
            [class.border-r-red-900]="BOUNDARY_POOLS.includes(pool.name)"
            [class.text-yellow-400]="getDividendOdds(race, pool.name) >= pool.threshold"
        >
          <span *ngIf="getDividendOdds(race, pool.name) > 0">
            {{ getDividendOdds(race, pool.name) }}
          </span>
        </td>
      </tr>

      <tr>
        <th class="border border-gray-700"></th>
        <th class="border border-gray-700 border-r-red-900">
          Cross Race
        </th>
        <th *ngFor="let pool of crossRacePools"
            class="border border-gray-700"
            [class.border-r-red-900]="BOUNDARY_POOLS.includes(pool.name)"
        >
          {{ pool.name }}
        </th>
        <th class="border border-gray-700"
            [colSpan]="singleRacePoolWithMultipleDividendCount"
        >
          Cross Race Pool Investment
        </th>
      </tr>
      <tr *counter="let row of crossRacePoolDividendRaces.length"
          class="hover:bg-gray-800"
      >
        <td class="border border-gray-700">
          {{ formatRace(getCrossRacePoolDividendRaces(row)) }}
        </td>
        <td class="border border-gray-700 border-r-red-900"></td>
        <td *ngFor="let pool of crossRacePools"
            class="border border-gray-700"
            [class.border-r-red-900]="BOUNDARY_POOLS.includes(pool.name)"
            [class.text-yellow-400]="getDividendOdds(getCrossRacePoolDividendRaces(row), pool.name) >= pool.threshold"
        >
          <span *ngIf="getDividendOdds(getCrossRacePoolDividendRaces(row), pool.name) > 0">
            {{ getDividendOdds(getCrossRacePoolDividendRaces(row), pool.name) | number }}
          </span>
        </td>
        <td *counter="let column of 2"
            class="border border-gray-700 px-6"
            [class.border-r-red-900]="column === 1"
            colspan="4"
        >
          <div class="grid grid-cols-2">
            <div class="text-left">
              {{ getCrossRacePoolInvestmentCellContent(row, column).pool }}
            </div>
            <div class="text-right">
              <span *ngIf="getCrossRacePoolInvestmentCellContent(row, column).investment > 0">
                {{ getCrossRacePoolInvestmentCellContent(row, column).investment | currency:'USD':'symbol':'1.0-0' }}
              </span>
            </div>
          </div>
        </td>
      </tr>
    </tbody>
  </table>
</div>
